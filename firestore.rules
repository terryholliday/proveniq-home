rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    // PHASE 4: Multi-Tenancy Enforcement
    function getTenantId() {
      // Extract tenantId from JWT custom claims (defaults to 'consumer')
      return isSignedIn() ? request.auth.token.get('tenantId', 'consumer') : 'consumer';
    }

    function isSameTenant(resourceTenantId) {
      return getTenantId() == resourceTenantId;
    }

    function isSystemOrAdmin() {
      return isAdmin() || (isSignedIn() && request.auth.token.get('tenantId', '') == 'system');
    }

    // --- Collection Rules ---

    // Users:
    // - Users can read/write their own profile within their tenant.
    // - Admins can read/write ALL profiles.
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if (isOwner(userId) || isAdmin()) && request.resource.data.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // Inventory Items (Multi-Tenant):
    // - Users can only access items in their tenant.
    // - Must validate tenantId on write.
    match /items/{itemId} {
      allow read: if isSignedIn() && (isSameTenant(resource.data.tenantId) || isSystemOrAdmin());
      allow create: if isSignedIn() && 
                       request.resource.data.tenantId == getTenantId() &&
                       request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && 
                       isSameTenant(resource.data.tenantId) && 
                       resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && 
                       isSameTenant(resource.data.tenantId) && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Households (Multi-Tenant):
    match /households/{householdId} {
      allow read: if isSignedIn() && (isSameTenant(resource.data.tenantId) || isSystemOrAdmin());
      allow write: if isSignedIn() && 
                      request.resource.data.tenantId == getTenantId() &&
                      request.resource.data.ownerId == request.auth.uid;
    }

    // Compliance Tasks:
    // - Multi-tenant aware.
    match /compliance_tasks/{taskId} {
      allow read: if isSystemOrAdmin() || (isSignedIn() && 
                     isSameTenant(resource.data.tenantId) &&
                     resource.data.assignedTo == request.auth.uid);
      allow create: if isSystemOrAdmin();
      allow update: if isSystemOrAdmin() || (isSignedIn() && 
                       isSameTenant(resource.data.tenantId) &&
                       resource.data.assignedTo == request.auth.uid);
      allow delete: if isSystemOrAdmin();
    }

    // Legal Documents (current collection):
    // 1. Allow public get for known public docs (prevents 403 if doc is missing/unseeded)
    // 2. Allow public read for any EXISTING document marked as published
    // 3. Admin has full access
    match /legal_docs/{docId} {
      // Allow public get for known public docs (prevents 403 if doc is missing/unseeded)
      allow get: if docId in ['privacy', 'tos', 'eula'];
      
      // Allow public read for any EXISTING document marked as published
      allow read: if resource != null && resource.data.status == 'published';

      // Admin has full access
      allow read, write: if isAdmin();
    }

    // Audit Logs (System Only):
    // - Write-only for authenticated users (via cloud functions).
    // - Read-only for system/admin.
    match /audit_logs/{logId} {
      allow read: if isSystemOrAdmin();
      allow create: if isSignedIn(); // Functions write here
      allow update, delete: if false; // Immutable
    }
    }
  }
}